# Sub2: l_mat.c と仕様書の対応関係マッピング

## 目的
本フォルダは、`eminj_l_mat.c`（噴射要求調停部品）と仕様書`11eminj-acw-15-c-t.docx`の対応関係を詳細に分析・マッピングした成果物を格納しています。

## 成果物一覧

### 1. specification_code_mapping.md
**内容:** 仕様書とコードの全体的な対応関係マッピング

**含まれる情報:**
- 仕様書の主要機能とコード実装の対応
- 主要関数の仕様書要求との対応
- データ構造の概要
- 優先調停ロジックの概要
- データフロー図
- コンパイルスイッチによる機能分岐

**対象読者:** 全体構造を把握したい開発者

---

### 2. function_list.md
**内容:** eminj_l_mat.c の全関数一覧と詳細説明

**含まれる情報:**
- 公開関数（extern）の一覧
- 内部関数（static）の一覧
- 各関数の行番号、呼び出しタイミング、機能概要
- 関数詳細（目的、処理内容、主要変数）
- 関数呼び出し関係図
- コンパイルスイッチと関数の関係

**対象読者:** 関数レベルの詳細を知りたい開発者

---

### 3. data_structure_mapping.md
**内容:** データ構造の定義と対応関係の詳細

**含まれる情報:**
- 主要データ構造の定義
  - 調停テーブル構造体（st_EMINJ_EMINJ_TBL）
  - 噴射制御構造体（st_EMINJ_EINJ, st_EMINJ_EMINJ）
  - 内部バッファ構造体
- グローバル変数の一覧と説明
- 内部制御変数（static）の説明
- 要求フラグビット定義
- 定数定義（マクロ、機能ID）
- データフロー図
- LSB値とfloat値の対応関係

**対象読者:** データ構造を理解したい開発者

---

### 4. arbitration_logic.md
**内容:** 優先調停ロジックの詳細説明

**含まれる情報:**
- 調停の3つのフェーズ（始動時/始動後/通常）
- 優先度の階層構造
- 優先度判定の実装
- 調停テーブル構造と走査処理
- 始動時から始動後への継続制御
- 調停結果の記憶
- データ取得と統合処理
- 補正係数の取得
- 同時性の確保
- SAC連携
- フェーズ遷移図
- 調停ロジックのフローチャート

**対象読者:** 調停ロジックの詳細を理解したい開発者

---

## 対象ソースファイル

### eminj_l_mat.c
- **場所:** `base/eminj-acw-15-c-t_src/eminj_l_mat.c`
- **行数:** 4961行
- **主要関数数:** 15以上
- **役割:** 噴射要求の調停処理（minj: Mediation of INJection requests）

### 関連ヘッダファイル
- `eminj.h` - 噴射制御部品の公開インターフェース定義
- `eminj_c.h` - 噴射制御C言語関連定義
- その他多数のインクルードファイル（約100個以上）

---

## 対象仕様書

### 11eminj-acw-15-c-t.docx
- **場所:** `base/eminj-acw-15-c-t_spec/11eminj-acw-15-c-t.docx`
- **段落数:** 約5095段落
- **主要セクション:**
  - A. 概要
  - B. 要求詳細
  - C. IF情報

---

## 主要な対応関係まとめ

### 仕様書要求とコード実装

| 仕様書要求 | コード実装 | 説明 |
|-----------|----------|------|
| 要求1-1: 基本値公開 | `vdg_eminj_pwon()` | 初期値設定と基本値のSAC公開 |
| 要求1-2: 優先調停 | `vdg_eminj_8msm()` 調停ロジック | 3つのフェーズによる優先調停処理 |
| 要求1-3: 同時性確保 | データセット関数群 | 構造体への一括セットと公開変数更新 |
| 要求2: SAC連携 | `vdg_ainjif_renew_injrq()` | 8msm処理最後でのSAC噴射要求受付 |

### 機能とID対応（主要機能）

| 機能ID | 機能名 | 分類 |
|--------|--------|------|
| 32 | 直噴起動制御 | 始動制御 |
| 34 | 始動性悪化防止制御 | 始動制御 |
| 54 | FC燃費制御 | 燃費制御 |
| 56 | 直噴デポジット抑制制御 | 部品保護 |
| 60 | 低圧圧力低下回復制御 | 部品保護 |
| 72 | インバランス噴射制御 | エミッション |
| 74 | アルコール燃料噴射制御 | 性能 |
| 86 | 過渡悪化防止制御 | 性能 |
| 88 | ベーパ発生制御 | 部品保護 |
| 90 | コールド始動制御 | 始動制御 |
| 92 | 出力制限上昇制御 | 性能 |
| 96 | 希薄希釈防止制御 | エミッション |

---

## データフロー概要

```
[各機能モジュール]
        ↓ dataget関数
[調停テーブル（始動時/始動後/通常）]
        ↓ 優先度判定
[最高優先度機能選択]
        ↓ データ統合
[構造体へセット（旧・新両対応）]
        ↓ 公開変数更新
[SAC噴射要求受付]
```

---

## 技術的特徴

### 1. 3段階調停
- **始動時調停**: 始動性重視
- **始動後調停**: 暖機制御、継続性確保
- **通常調停**: 定常運転制御

### 2. 継続性制御
始動時に調停された機能が始動後も優先される仕組み

### 3. 同時性確保
NE割り込みとの同期を考慮した一括更新

### 4. 柔軟な構成
コンパイルスイッチにより多様なEFI方式・HVシステムに対応

---

## 用語説明

### 略語
- **minj**: Mediation of INJection requests（噴射要求調停）
- **SAC**: Injection control module（噴射制御モジュール）
- **EFI**: Electronic Fuel Injection（電子燃料噴射）
- **FC**: Fuel Cut（燃料カット）
- **PL**: Partial Lift（パーシャルリフト）
- **FL**: Full Lift（フルリフト）
- **HV**: Hybrid Vehicle（ハイブリッド車）
- **EGR**: Exhaust Gas Recirculation（排気ガス再循環）
- **NOX**: Number of O2 sensor banks（O2センサバンク数）
- **NCYL**: Number of Cylinders（気筒数）

### 概念
- **調停**: 複数の機能要求から最適なものを選択する処理
- **優先度**: 機能の重要度を示す数値（小さいほど高優先）
- **dataget関数**: 各機能モジュールが持つデータ取得関数
- **要求フラグ**: どのパラメータを要求しているかを示すビットフラグ

---

## 分析方法

### 使用ツール
- Python（docx解析、テキスト抽出）
- grep/view（コード検索、閲覧）

### 分析手順
1. 仕様書（.docx）からテキスト抽出
2. ソースコード構造の把握
   - 関数一覧の抽出
   - データ構造の特定
   - コンパイルスイッチの調査
3. 対応関係のマッピング
   - 要求と実装の紐付け
   - 関数と機能の対応
   - データフローの追跡
4. ドキュメント作成

---

## 活用方法

### 新規開発者向け
1. まず `specification_code_mapping.md` で全体像を把握
2. `function_list.md` で関数レベルの理解
3. `data_structure_mapping.md` でデータ構造の理解
4. `arbitration_logic.md` で調停ロジックの詳細理解

### 機能追加時
1. `arbitration_logic.md` で調停ロジックを確認
2. `data_structure_mapping.md` で必要な構造体を確認
3. 新機能のID割り当て（未使用IDを選択）
4. dataget関数の実装
5. 調停テーブルへの登録

### デバッグ時
1. `u1g_eminj_einjmedislid` で現在の調停IDを確認
2. `function_list.md` でID対応機能を特定
3. `data_structure_mapping.md` で関連変数を確認
4. ブレークポイント設定とデバッグ

---

## 関連情報

### 親タスク
- JP-D154Z-TES-PARTS/eminj-acw-16-2#1

### 作業日
2025-11-07

### 作成者
GitHub Copilot

---

## 注意事項

### コンパイルスイッチ依存
- 本ドキュメントは全てのコンパイルスイッチパターンを網羅していません
- 実際の動作は車種・仕様により異なる可能性があります
- 対象コードを確認する際は、該当するコンパイルスイッチの設定を確認してください

### バージョン
- 本マッピングは特定バージョンのソースコードに基づきます
- コード変更により内容が古くなる可能性があります

### 推定箇所
- 一部の行番号や処理内容は、コード分析による推定を含みます
- 詳細は実際のソースコードで確認してください

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-11-07 | 初版作成 |

