# l_mat.c と仕様書の対応関係マッピング

## 概要
本ドキュメントは、`eminj_l_mat.c`（L_mat調停部品）と仕様書`11eminj-acw-15-c-t.docx`の対応関係を示すマッピングドキュメントです。

## 仕様書の主要機能

### A. 概要（仕様書セクションA）

#### 1. 機能概要
**仕様書の記述:**
- minj : Mediation of INJection requests
- 各機能が要求する噴射モードを集約して最適な混合気を形成する為に、機能の優先調停を行う
- 噴射、高圧・低圧燃料ポンプは構造体で取得する
- 各機能からの要求は「始動時」「始動後」「通常」の３つの調停テーブルで管理

**対応コード:**
- ファイル: `eminj_l_mat.c`
- 主要関数: 
  - `vdg_eminj_8msm()` - 噴射要求の調停処理（8ms中タスク）
  - `vdg_eminj_pwon()` - 初期値設定

---

## 主要関数の対応関係

### 1. vdg_eminj_pwon() - 初期値設定
**行番号:** 722-804

**仕様書対応:**
- 要求1-1: 各機能からの要求がないときは基本の要求値をSACに公開する

**機能:**
- 噴射関連パラメータの初期化
- 基本値の設定
  - `s2s_EMINJ_KRICHI` - 噴射量補正係数初期値
  - 噴射量算出係数の初期化（kpfi, kpfix, kpfin）
  - 噴射終了時期の基本値設定

**主要変数:**
```c
st_EMINJ_EINJ stg_eminj_einj;      // 噴射部品制御構造体
st_EMINJ_EMINJ stg_eminj_eminj;    // 新噴射部品制御構造体
s2g_eminj_ekrichx                  // 噴射量補正係数
f4g_eminj_ekpfi                    // ポート噴射量算出係数
```

---

### 2. vdg_eminj_8msm() - 噴射要求の調停処理
**行番号:** 815-2593

**仕様書対応:**
- 要求1-2: 各機能が要求する噴射方式を集約して最適な混合気を形成する為に、機能の優先調停を行う
- 要求1-3: 調停された各機能が要求した噴射モード、噴射開始時期等を同時性を確保してSACに公開
- 要求2: 本部品の8msm処理実施後にSACの噴射要求受付関数をコールする

**主要処理フロー:**
1. **優先度選択処理**
   - 始動時優先度 (`u1s_eminj_estpri`)
   - 始動後優先度 (`u1s_eminj_eastpri`)
   - 通常優先度 (`u1s_eminj_epri`)
   - 最終優先度選択 (`u1s_eminj_eprisel_fix`)

2. **調停テーブルによる要求データ取得**
   - 行2033-2217: 調停テーブル（`stt_eminj_tbl[]`）からデータ取得
   - ID順に各機能のdataget関数を呼び出し

3. **データの同時性確保**
   - `vds_eminj_einj_dataset()` - 旧構造体へのデータセット
   - `vds_eminj_eminj_dataset()` - 新構造体へのデータセット

4. **SAC噴射要求受付処理**
   - 行2583: `vdg_ainjif_renew_injrq()` - アプリ噴射要求更新

---

## データ構造の対応

### 1. 調停テーブル構造
**コード定義（行343-353）:**
```c
typedef struct
{
    void (* pt_dataget)( st_EMINJ_EMINJ_DEF * ptt_store );
    u1 u1_id;  // lsb=1 :ID
} st_EMINJ_EMINJ_TBL;
```

**仕様書対応:**
- 各機能毎に複数のIDと優先度を付与
- 機能の優先調停管理

### 2. 噴射制御構造体
**主要構造体:**
- `st_EMINJ_EMINJ` - 新噴射部品制御構造体（行457）
- `st_EMINJ_EINJ` - 噴射部品制御構造体（行460）

**含まれるパラメータ:**
- 噴射モード (`einjmod`)
- 噴射開始時期 (`eainjpn[]`, `eainjdn[]`)
- 始動時噴射量 (`eqinjstpn[]`, `eqinjstdn[]`)
- 噴射量算出係数 (`ek1fn[]`, `ek2fn[]`, `ek3fn[]`)
- 噴射量補正係数 (`ekrchref[]`)
- FC燃料噴射量 (`eqfc[]`)

---

## 優先調停ロジック

### 調停テーブルの種類（仕様書対応）
**仕様書記述:** 3つの調停テーブルで管理
1. 始動時テーブル
2. 始動後テーブル  
3. 通常テーブル

**コード実装（行2033-2217）:**
```c
if ( u1s_eminj_estpri != (u1)0U )  // 始動時優先度あり
{
    // 始動時テーブルから取得
}
else if ( u1s_eminj_eastpri != (u1)0U )  // 始動後優先度あり
{
    // 始動後テーブルから取得
}
else  // 通常優先度
{
    // 通常テーブルから取得
}
```

---

## 主要機能モジュールとID対応

### コンパイルスイッチ別機能（行412-449）

| 機能ID | 機能名 | 対応define | 行番号 |
|--------|--------|-----------|--------|
| 32 | 直噴起動制御 | RESTAHOT_ID | 412 |
| 34 | 始動性悪化防止制御 | KCST_ID | 413 |
| 54 | FC燃費制御 | RTNFC_ID | 417 |
| 56 | 直噴デポジット抑制制御 | CLRDEPI_ID | 421 |
| 60 | 低圧圧力低下回復制御 | FPLDLV_ID | 425 |
| 72 | インバランス噴射制御 | INJIMB_ID | 429 |
| 74 | アルコール燃料噴射制御 | ACTAREFUEL_ID | 433 |
| 86 | 過渡悪化防止制御 | KCTRN_ID | 437 |
| 88 | ベーパ発生制御 | RDVAP_ID | 441 |
| 90 | コールド始動制御 | DWNPR_ID | 442 |
| 92 | 出力制限上昇制御 | PWRUP_ID | 445 |
| 96 | 希薄希釈防止制御 | PRVDIL_ID | 448 |

---

## データフロー

### 入力（各機能モジュールから）
1. 各機能の`dataget`関数経由で要求データ取得
   - 噴射モード要求
   - 噴射開始時期要求
   - 噴射量要求
   - 補正係数要求

### 処理（調停ロジック）
1. 優先度判定（始動時/始動後/通常）
2. 最高優先度機能の選択
3. 選択された機能のデータ取得
4. 基本値との統合

### 出力（SACへ公開）
**公開変数（仕様書セクションC.IF情報1）:**
- `u2g_eminj_einjmodfix` - 現在確定噴射モード
- `s2g_eminj_eainjpn[]` - ポートn段目噴射開始時期
- `s2g_eminj_eainjdn[]` - 直噴n段目噴射開始時期
- `s4g_eminj_eqinjstpn[]` - ポートn段目始動時噴射量
- `s4g_eminj_eqinjstdn[]` - 直噴n段目始動時噴射量
- `s4g_eminj_eqfc[]` - FC燃料噴射量
- `s2g_eminj_ek1fn[]` - 1段目噴射量算出係数
- `s2g_eminj_ekrchref[]` - 噴射量補正係数

---

## 補助関数群

### 1. vds_eminj_einj_datacopy() - データコピー関数
**行番号:** 4014-4152
**機能:** 旧構造体形式のデータコピー

### 2. vds_eminj_einj_dataset() - データセット関数
**行番号:** 2855-3001
**機能:** 調停結果を旧構造体形式にセット

### 3. vds_eminj_eminj_dataset() - 新データセット関数
**行番号:** 3737-4002
**機能:** 調停結果を新構造体形式にセット

### 4. vds_eminj_einj_dataconv() - データ変換関数
**行番号:** 4470-4654
**機能:** 集約対象用の旧→新構造体データ移行

### 5. vds_eminj_einj_dataconv_rev() - 逆データ変換関数
**行番号:** 4669-4895
**機能:** 集約対象用の新→旧構造体データ移行

---

## 重要な制御フラグ

### 1. NE割り込み関連
**変数:** `u1s_eminj_exnercdfew` - NE割り込みタスク実行フラグ
**機能:** NE割り込み時のタスク実行制御
**仕様書対応:** 要求1-3の同時性確保

### 2. 始動状態フラグ
**変数:** 
- `u1s_eminj_exasto` - 始動フラグ（前回値）
- `u1s_eminj_exast_lch` - 始動フラグ（ラッチ用）
**機能:** 始動時/始動後の判定

### 3. 調停ID管理
**変数:** `u1g_eminj_einjmedislid` - 噴射部品調停ID
**機能:** 現在調停されている機能のID保持

---

## コンパイルスイッチによる機能分岐

### EFI方式別処理
```c
#if JEEFI == u1g_EJCC_DUAL      // デュアルINJ（ポート+直噴）
#if JEEFI == u1g_EJCC_D4        // D-4（直噴のみ）
#if JEEFI == u1g_EJCC_PORT      // ポート噴射のみ
```

### HV関連処理
```c
#if JEALLHV_E == u1g_EJCC_ALLHV_E  // ALL HV
#if JEEGMG_E == u1g_EJCC_HVPLGR_E   // EG-MGプラグイン
#if JEEGMG_E == u1g_EJCC_HVCLUTCH_E // EG-MGクラッチ
```

### その他機能スイッチ
```c
#if JEPRDEMAND == u1g_EJCC_USE     // 可変圧制御有
#if JESS == u1g_EJCC_USE           // SS機能有
#if JEFFV != u1g_EJCC_NOT_USE      // FFV仕様有
```

---

## まとめ

### 主要な対応関係

1. **仕様書要求1-1** → `vdg_eminj_pwon()` : 基本値設定
2. **仕様書要求1-2** → `vdg_eminj_8msm()`の調停ロジック : 優先調停処理
3. **仕様書要求1-3** → データセット関数群 : 同時性確保した公開
4. **仕様書要求2** → `vdg_ainjif_renew_injrq()` : SAC噴射要求受付

### データフロー概要
```
各機能モジュール
    ↓ (dataget関数)
調停テーブル（始動時/始動後/通常）
    ↓ (優先度判定)
最高優先度機能選択
    ↓ (データ統合)
構造体へセット（旧・新両対応）
    ↓ (公開変数更新)
SAC噴射要求受付
```

### ファイル構成
- **メイン処理:** 行714-2593（pwon, 8msm関数）
- **補助関数:** 行2596-4960（データセット、変換関数群）
- **定義部:** 行1-712（インクルード、定数、構造体定義）

---

## 参考情報

### ソースファイル
- `eminj_l_mat.c` - 約4961行
- 主要関数数: 15以上
- コンパイルスイッチ: 20種類以上

### 仕様書
- `11eminj-acw-15-c-t.docx` - 約5095段落
- セクション構成: A概要、B要求詳細、C IF情報等

### 部品名称
- minj : Mediation of INJection requests（噴射要求調停部品）
- L_mat : 調停（Mediation）の意

---

生成日: 2025-11-07
