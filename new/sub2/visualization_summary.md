# 可視化サマリー：仕様書とコードの対応マップ

## クイックリファレンス

### ファイル構成
```
eminj-acw-16-2/
├── base/
│   ├── eminj-acw-15-c-t_src/
│   │   └── eminj_l_mat.c          ← 対象ソースコード（4961行）
│   └── eminj-acw-15-c-t_spec/
│       └── 11eminj-acw-15-c-t.docx ← 対象仕様書（5095段落）
└── new/
    └── sub2/                       ← 本マッピング成果物
        ├── README.md
        ├── specification_code_mapping.md
        ├── function_list.md
        ├── data_structure_mapping.md
        └── arbitration_logic.md
```

---

## 仕様書の主要セクションとコード対応

```
┌─────────────────────────────────────────────────────────────────┐
│ 仕様書: 11eminj-acw-15-c-t.docx                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ A. 概要                                                         │
│ ├─ 1. 機能                                                      │
│ │   └─ minj: Mediation of INJection requests                  │
│ │       ⇩                                                       │
│ │       eminj_l_mat.c                                          │
│ │       - 噴射要求の調停処理を実装                              │
│ │       - 始動時/始動後/通常の3テーブル管理                     │
│ │                                                              │
│ └─ 2. 要求詳細                                                  │
│                                                                 │
│ B. 要求詳細                                                     │
│ ├─ 要求1: 最適な燃料噴射の方式を決定                             │
│ │   ├─ 要求1-1: 基本値公開                                      │
│ │   │   ⇩                                                       │
│ │   │   vdg_eminj_pwon() [行722-804]                          │
│ │   │   - 初期値設定                                            │
│ │   │   - 基本要求値のSAC公開                                   │
│ │   │                                                          │
│ │   ├─ 要求1-2: 優先調停                                        │
│ │   │   ⇩                                                       │
│ │   │   vdg_eminj_8msm() [行815-2593]                         │
│ │   │   - 調停ロジック実装                                      │
│ │   │   - 優先度判定（始動時/始動後/通常）                      │
│ │   │   - 調停テーブル走査                                      │
│ │   │                                                          │
│ │   └─ 要求1-3: 同時性確保した公開                              │
│ │       ⇩                                                       │
│ │       vds_eminj_einj_dataset() [行2855-3001]                │
│ │       vds_eminj_eminj_dataset() [行3737-4002]               │
│ │       - 構造体への一括セット                                  │
│ │       - NE割り込み考慮                                        │
│ │                                                              │
│ └─ 要求2: SAC連携                                               │
│     ⇩                                                           │
│     vdg_ainjif_renew_injrq() [行2583]                          │
│     - 8msm処理最後で呼び出し                                     │
│     - 同時性確保                                                │
│                                                                 │
│ C. IF情報                                                       │
│ └─ 公開変数定義                                                 │
│     ⇩                                                           │
│     グローバル変数（行463-530）                                  │
│     - u2g_eminj_einjmodfix                                      │
│     - s2g_eminj_eainjpn[]                                       │
│     - s4g_eminj_eqinjstpn[]                                     │
│     - s2g_eminj_ekrichx                                         │
│     - 他多数                                                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 主要関数マップ（行番号付き）

```
┌────────────────────────────────────────────────────────────┐
│ eminj_l_mat.c 関数マップ                                  │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ [714-804] vdg_eminj_pwon()                                │
│ │                                                          │
│ │  目的: 電源投入時初期化                                  │
│ │  処理:                                                   │
│ │  ・噴射量補正係数の初期値設定                             │
│ │  ・基本値の設定と構造体への格納                           │
│ │                                                          │
│ │                                                          │
│ [815-2593] vdg_eminj_8msm()                    ◄ メイン処理
│ │                                                          │
│ │  目的: 噴射要求の調停処理（8ms周期）                      │
│ │  処理:                                                   │
│ │  ┌──────────────────────────────────────┐             │
│ │  │ [817-1000] 初期化                        │             │
│ │  │  └─ ローカル変数初期化                  │             │
│ │  │                                          │             │
│ │  │ [1002-1100] 始動状態判定                 │             │
│ │  │  └─ 始動フラグ判定                      │             │
│ │  │                                          │             │
│ │  │ [1102-1500] 優先度選択                   │             │
│ │  │  ├─ 始動時優先度                        │             │
│ │  │  ├─ 始動後優先度                        │             │
│ │  │  └─ 通常優先度                          │             │
│ │  │                                          │             │
│ │  │ [2033-2217] 調停テーブル処理             │             │
│ │  │  └─ ID順にdataget関数呼び出し          │             │
│ │  │                                          │             │
│ │  │ [2220-2450] 補正処理                     │             │
│ │  │  └─ emkrichb連携                        │             │
│ │  │                                          │             │
│ │  │ [2453-2580] データ公開処理               │             │
│ │  │  ├─ 構造体セット                        │             │
│ │  │  └─ 公開変数更新                        │             │
│ │  │                                          │             │
│ │  │ [2581-2590] SAC連携                      │             │
│ │  │  └─ vdg_ainjif_renew_injrq()            │             │
│ │  └──────────────────────────────────────┘             │
│ │                                                          │
│ │                                                          │
│ [2855-3001] vds_eminj_einj_dataset()          ◄ サポート関数
│ │  目的: 旧構造体へのデータセット                           │
│ │                                                          │
│ [3737-4002] vds_eminj_eminj_dataset()                     │
│ │  目的: 新構造体へのデータセット                           │
│ │                                                          │
│ [4014-4152] vds_eminj_einj_datacopy()                     │
│ │  目的: 旧構造体のデータコピー                             │
│ │                                                          │
│ [4380-4458] vds_eminj_einj_datacopy2()                    │
│ │  目的: 新構造体のデータコピー                             │
│ │                                                          │
│ [4470-4654] vds_eminj_einj_dataconv()                     │
│ │  目的: 旧→新構造体変換                                   │
│ │                                                          │
│ [4669-4895] vds_eminj_einj_dataconv_rev()                 │
│ │  目的: 新→旧構造体変換                                   │
│ │                                                          │
│ [4907-4912] vds_eminj_erestahot_rap_dataget()  ◄ ラッパー  │
│ │  目的: 直噴起動制御データ取得                             │
│ │                                                          │
│ [4925-4930] vds_eminj_erdpn_rap_dataget()                 │
│ │  目的: PN粒子制御データ取得                              │
│ │                                                          │
│ [4942-4945] vds_eminj_dummy_emedi_dataget()    ◄ ダミー   │
│ │  目的: ダミー関数（旧）                                  │
│ │                                                          │
│ [4956-4959] vds_eminj_dummy_emedi_dataget2()              │
│    目的: ダミー関数（新）                                  │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## データ構造の階層図

```
┌──────────────────────────────────────────────────────────┐
│ データ構造の階層                                         │
├──────────────────────────────────────────────────────────┤
│                                                          │
│ ◆ 調停テーブル                                           │
│   ┌─────────────────────────────────────┐             │
│   │ st_EMINJ_EMINJ_TBL (旧)                │             │
│   │ st_EMINJ_EMINJ_TBL2 (新)               │             │
│   ├─────────────────────────────────────┤             │
│   │ ・pt_dataget: 関数ポインタ             │             │
│   │ ・u1_id: 機能ID                        │             │
│   └─────────────────────────────────────┘             │
│        ↓ 使用                                            │
│   ┌─────────────────────────────────────┐             │
│   │ 調停テーブル配列                       │             │
│   │ stt_eminj_tbl[]                        │             │
│   ├─────────────────────────────────────┤             │
│   │ [0] {func_ptr_1, ID_1}                 │             │
│   │ [1] {func_ptr_2, ID_2}                 │             │
│   │ ...                                    │             │
│   │ [N] {dummy_func, 0}                    │             │
│   └─────────────────────────────────────┘             │
│                                                          │
│ ◆ 噴射制御構造体                                         │
│   ┌─────────────────────────────────────┐             │
│   │ st_EMINJ_EINJ (旧構造体)               │             │
│   ├─────────────────────────────────────┤             │
│   │ ・u1_pri                               │             │
│   │ ・u4_einjrq_dat                        │             │
│   │ ・u2_einjmod                           │             │
│   │ ・s2_eainjp1, s2_eainjp2, ...          │             │
│   │ ・s2_eainjd1, s2_eainjd2, ...          │             │
│   │ ・s4_eqinjstp1, s4_eqinjstp2, ...      │             │
│   │ ・s4_eqfc[]                            │             │
│   │ ・s2_ek1fn[], s2_ek2fn[], s2_ek3fn[]   │             │
│   │ ・s2_ekrchref[]                        │             │
│   │ ・他多数                               │             │
│   └─────────────────────────────────────┘             │
│                                                          │
│   ┌─────────────────────────────────────┐             │
│   │ st_EMINJ_EMINJ (新構造体)              │             │
│   ├─────────────────────────────────────┤             │
│   │ ・u1_pri                               │             │
│   │ ・u4_einjrq_dat                        │             │
│   │ ・u2_einjmod                           │             │
│   │ ・u4_einjptn (新規)                    │             │
│   │ ・s2_eainjpn[] (配列化)                │             │
│   │ ・s2_eainjdn[] (配列化)                │             │
│   │ ・s4_eqinjstpn[] (配列化)              │             │
│   │ ・s4_eqinjstdn[] (配列化)              │             │
│   │ ・s4_eqinjflfix[] (新規)               │             │
│   │ ・s4_eqinjplfix[] (新規)               │             │
│   │ ・他旧構造体と同等                      │             │
│   └─────────────────────────────────────┘             │
│                                                          │
│ ◆ グローバル変数（インスタンス）                          │
│   ┌─────────────────────────────────────┐             │
│   │ stg_eminj_einj  : st_EMINJ_EINJ       │             │
│   │ stg_eminj_eminj : st_EMINJ_EMINJ      │             │
│   └─────────────────────────────────────┘             │
│        ↓ 公開                                            │
│   ┌─────────────────────────────────────┐             │
│   │ 公開変数（SAC連携用）                  │             │
│   ├─────────────────────────────────────┤             │
│   │ u2g_eminj_einjmodfix                   │             │
│   │ s2g_eminj_eainjpn[]                    │             │
│   │ f4g_eminj_eainjpn[]                    │             │
│   │ s4g_eminj_eqinjstpn[]                  │             │
│   │ s2g_eminj_ekrichx                      │             │
│   │ u1g_eminj_einjmedislid                 │             │
│   │ 他多数                                 │             │
│   └─────────────────────────────────────┘             │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## 調停フロー（簡易版）

```
                     [電源ON]
                        │
                        ▼
              ┌───────────────┐
              │ vdg_eminj_pwon │
              │  初期値設定     │
              └───────────────┘
                        │
          ┌─────────────┴─────────────┐
          │   8ms周期タスク実行         │
          ▼                             │
┌────────────────────────────┐        │
│ vdg_eminj_8msm()            │◄───────┘
│  噴射要求調停処理            │
├────────────────────────────┤
│                             │
│ [1] 始動状態判定             │
│     ├─ 始動中?              │
│     └─ 始動後?              │
│                             │
│ [2] 優先度取得               │
│     ├─ 始動時優先度          │
│     ├─ 始動後優先度          │
│     └─ 通常優先度            │
│                             │
│ [3] フェーズ判定             │
│     ┌──────────────┐      │
│     │ 始動時優先度あり?│      │
│     └─┬──────────┬─┘      │
│       YES          NO        │
│        │           │         │
│        ▼           ▼         │
│   始動時調停   始動後優先度?  │
│                   │           │
│                  YES          │
│                   │           │
│                   ▼           │
│              始動後調停        │
│                   │           │
│                   NO          │
│                   │           │
│                   ▼           │
│                通常調停        │
│                             │
│ [4] 調停テーブル走査         │
│     └─ ID順に選択           │
│                             │
│ [5] データ取得               │
│     └─ dataget関数実行      │
│                             │
│ [6] 補正係数取得             │
│     └─ emkrichb連携         │
│                             │
│ [7] 構造体セット             │
│     ├─ 旧構造体              │
│     └─ 新構造体              │
│                             │
│ [8] 公開変数更新             │
│                             │
│ [9] SAC連携                 │
│     └─ vdg_ainjif_renew_injrq()
│                             │
└────────────────────────────┘
         │
         └───► 次の8ms周期へ
```

---

## 機能ID一覧（優先度順）

```
┌─────┬──────────────────┬──────────┬────────┐
│  ID │ 機能名             │ 分類       │ フェーズ│
├─────┼──────────────────┼──────────┼────────┤
│  32 │ 直噴起動制御        │ 始動制御   │ 始動時  │
│  34 │ 始動性悪化防止制御   │ 始動制御   │ 始動時  │
│  54 │ FC燃費制御          │ 燃費制御   │ 通常    │
│  56 │ 直噴デポジット抑制   │ 部品保護   │ 通常    │
│  60 │ 低圧圧力低下回復    │ 部品保護   │ 通常    │
│  72 │ インバランス噴射    │ エミッション│ 通常    │
│  74 │ アルコール燃料噴射   │ 性能      │ 通常    │
│  86 │ 過渡悪化防止        │ 性能      │ 通常    │
│  88 │ ベーパ発生制御      │ 部品保護   │ 通常    │
│  90 │ コールド始動        │ 始動制御   │ 始動時  │
│  92 │ 出力制限上昇        │ 性能      │ 通常    │
│  96 │ 希薄希釈防止        │ エミッション│ 通常    │
└─────┴──────────────────┴──────────┴────────┘

※ ID小が高優先度
※ 同フェーズ内で最小IDが選択される
```

---

## 要求フラグのビットマップ

```
u4_einjrq_dat (32bit)
┌─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┐
│ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │0│ bit0: RQINJMODE
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │1│ bit1: RQAINJP
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │2│ bit2: RQAINJP1
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │3│ bit3: RQAINJP2
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ ...
│ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ (各パラメータの要求フラグ)
└─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┴─┘

各ビットが1の場合、該当パラメータを要求中
0の場合は基本値を使用
```

---

## ドキュメント活用ガイド

```
┌─────────────────────────────────────────────┐
│ 目的別ドキュメント選択ガイド                 │
├─────────────────────────────────────────────┤
│                                             │
│ ◆ 全体像を把握したい                        │
│   → specification_code_mapping.md          │
│   → README.md                              │
│                                             │
│ ◆ 特定の関数を理解したい                     │
│   → function_list.md                       │
│                                             │
│ ◆ データ構造を理解したい                     │
│   → data_structure_mapping.md              │
│                                             │
│ ◆ 調停ロジックの詳細を知りたい               │
│   → arbitration_logic.md                   │
│                                             │
│ ◆ 図で理解したい                            │
│   → 本ファイル（visualization_summary.md）  │
│                                             │
└─────────────────────────────────────────────┘
```

---

生成日: 2025-11-07
作成者: GitHub Copilot

